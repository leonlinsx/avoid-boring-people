---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';
import { getCollection } from 'astro:content';
import { SITE_OG_IMAGE, SITE_TITLE } from '../../consts';
import SearchBar from '../../components/SearchBar.astro';
import { enrichPost } from '../../utils/text';
import { searchPosts } from '../../utils/search';
import searchClientUrl from '../../scripts/search-page-init.ts?url';

const q = Astro.url?.searchParams.get('q')?.trim() ?? '';

// Fetch and enrich all posts
const allPosts = await getCollection('blog');

const posts = allPosts
  .map(enrichPost)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const filteredPosts = q ? searchPosts(posts, q) : posts;
const searchItems = posts.map((post) => ({
  id: post.id,
  slug: post.slug ?? post.id.replace(/\/index\.md$/, ''),
  title: post.data.title ?? 'Untitled',
  description: post.data.description ?? '',
  category: post.data.category ?? '',
  pubDate: post.data.pubDate ? post.data.pubDate.toISOString() : null,
  readingTime: typeof post.data.readingTime === 'number' ? post.data.readingTime : null,
  heroImage:
    typeof post.data.heroImage === 'string'
      ? { kind: 'external', src: post.data.heroImage }
      : post.data.heroImage
      ? {
          kind: 'asset',
          src: post.data.heroImage.src,
          width: post.data.heroImage.width,
          height: post.data.heroImage.height,
        }
      : null,
  fallbackImage: SITE_OG_IMAGE,
}));

---

<BaseLayout
  title={`Search | ${SITE_TITLE}`}
  description={
    q ? `Search results for "${q}"` : `Search the full ${SITE_TITLE} archive`
  }
>
  <div class="search-header">
    <h1>Search Results</h1>
    <SearchBar q={q} id="client-search-input" variant="full" />
  </div>

  <div id="post-list">
    {filteredPosts.map((post) => (
      <PostCard post={post} />
    ))}
  </div>

  <p
    id="search-empty"
    class:list={['search-empty', filteredPosts.length === 0 && q ? 'is-visible' : '']}
    role="status"
    aria-live="polite"
  >
    No posts found for “{q}”. Try a different keyword.
  </p>
  <script type="application/json" id="search-data">
    {JSON.stringify(searchItems).replace(/</g, '\\u003c')}
  </script>
  <script type="module" src={searchClientUrl}></script>
</BaseLayout>

<style>
  .search-header {
    display: flex;
    flex-direction: column;
    align-items: stretch;
    gap: 1rem;
    margin-bottom: 2rem;
    width: 100%;
  }
  .search-bar {
    display: flex;
    align-items: center;
    width: 100%;
    max-width: none;
    background: var(--color-bg);
    border: 1.5px solid var(--color-border);
    border-radius: 999px;
    padding: 0.25rem 0.75rem 0.25rem 1rem;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.03);
  }
  .search-input {
    flex: 1;
    padding: 0.35rem 0.75rem;
    border: 1px solid var(--color-border);
    border-radius: 999px;
    font-size: 0.95rem;
    width: 100%;
    box-sizing: border-box;
    color: var(--color-text);
    background: transparent;
    caret-color: var(--color-text);
  }
  .search-btn {
    padding: 0.35rem 0.75rem;
    border-radius: 999px;
    border: none;
    background: transparent;
    color: var(--color-text);
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.2s;
    flex-shrink: 0;
  }
  .search-btn:hover {
    opacity: 0.85;
  }
  #post-list {
    display: grid;
    gap: 1.5rem;
    width: 100%;
  }
  .search-empty {
    display: none;
    margin-top: 1.5rem;
    font-style: italic;
    color: var(--color-text-dimmed);
  }
  .search-empty.is-visible {
    display: block;
  }
</style>
