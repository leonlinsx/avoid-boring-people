---
import BaseLayout from "../layouts/BaseLayout.astro";
import PostList from "../components/PostList.astro";
import { getCollection } from "astro:content";
import { SITE_TITLE } from "../consts";
import { enrichPost } from "../utils/text"; // ✅ import enrichment

const allPosts = await getCollection("blog");

// Pick featured posts, enriched
const featured = allPosts
  .filter((post) => post.data.featured)
  .map(enrichPost) // ✅ ensures slug + readingTime exist
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<BaseLayout
  title={`Home | ${SITE_TITLE}`}
  description="Writing on finance, tech, and other ideas by Leon Lin"
>
  <head>
    <!-- ✅ Only preload on index page -->
    <link
      rel="preload"
      as="image"
      href="/logos/substack_banner.webp"
      imagesrcset="/logos/substack_banner.webp"
      imagesizes="100vw"
    />
  </head>

  <!-- Hero -->
  <section class="hero">
    <div class="banner-wrapper">
      <img
        src="/logos/substack_banner.webp"
        alt="Avoid Boring People newsletter banner"
        class="banner-img"
        height="120"
        fetchpriority="high"
      />
      <span class="tooltip">
        I chose the name because of the double meaning. People always default to
        one interpretation, but I promise I'm not as intimidating as I sound.
      </span>
    </div>

    <h1>I write to think clearly about finance, tech, and strange ideas</h1>
    <p>
      Sharing my writing helps my ideas compound and helps me connect with
      curious people.
    </p>
    <p class="subtle-cta">
      Start with a few favourites below, or
      <a href="#subscribe">join 5,000+ readers</a> who get updates by email.
    </p>
  </section>

  <!-- Start Here -->
  <section class="content-section">
    <h2>Best Of</h2>
    <p class="subtext">Essays that highlight what my writing is about</p>
    <PostList posts={featured} />
  </section>

  <!-- Newsletter Signup -->
  <section id="subscribe" class="signup">
    <h2>Join the Newsletter</h2>
    <p class="subtext">
      Irregular essays on finance, tech, and life. Delivered directly to your
      inbox.
    </p>
    <div class="signup-box" aria-label="Newsletter signup form">
      <iframe
        src="https://avoidboringpeople.substack.com/embed"
        width="100%"
        height="150"
        frameborder="0"
        scrolling="no"
        title="Newsletter signup form"></iframe>
    </div>
    <p class="trust-text">Free. No spam. Unsubscribe anytime.</p>
  </section>

  <!-- Featured Logos -->
  <section class="featured">
    <h2>As featured in</h2>
    <div class="logo-row">
      <img src="/logos/hacker_news_logo.webp" alt="HackerNews" />
      <img src="/logos/failory_logo.webp" alt="Failory" />
    </div>
  </section>
</BaseLayout>
